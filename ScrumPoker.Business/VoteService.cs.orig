using ScrumPoker.Business.Interfaces.Interfaces;
using ScrumPoker.Business.Models.Models;
using ScrumPoker.Common.NotFoundExceptions;
using ScrumPoker.DataAccess.Interfaces;

namespace ScrumPoker.Business;

/// <inheritdoc />
public class VoteService : IVoteService
{
    private readonly IGameRoomService _gameRoomService;
    private readonly IRoundService _roundService;
    private readonly IUserManager _userManager;
    private readonly IVoteRepository _voteRepository;

    public VoteService(IVoteRepository voteRepository, IUserManager userManager, IRoundService roundService,
        IGameRoomService gameRoomService)
    {
        _voteRepository = voteRepository;
        _userManager = userManager;
        _roundService = roundService;
        _gameRoomService = gameRoomService;
    }

    public async Task<Vote> GetById(int id)
    {
        return await _voteRepository.GetById(id);
    }

    public async Task<Vote> CreateOrUpdate(Vote vote)
    {
        var roundDto = await _roundService.GetById(vote.RoundId);
        var gameRoomDto = await _gameRoomService.GetById(roundDto.GameRoomId);
        var currentUserId = _userManager.GetCurrentUserId();
        var playerList = gameRoomDto.Players;
        var playerCheck = playerList.SingleOrDefault(x => x.Id == currentUserId);
        if (playerCheck == null)
<<<<<<< HEAD
            throw new IdNotFoundException($"No user with ID {currentUserId} found in game room ID {gameRoomDto.Id}");
        
        vote.PlayerId = currentUserId;
=======
            throw new IdNotFoundException($"No user with ID {playerId} found in game room ID {gameRoomDto.Id}");

        vote.PlayerId = playerId;
>>>>>>> d79be179a93dc98fcf55a45ef1f028a11ddee558
        return await _voteRepository.CreateOrUpdate(vote);
    }

    public async Task ClearRoundVotes(int roundId)
    {
        await _voteRepository.ClearRoundVotes(roundId);
    }
}